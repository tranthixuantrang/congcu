<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Minimart ‚Äî Qu·∫£n l√Ω kho</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
    }

    .modal-content label {
      display: block;
      margin-top: 8px;
      font-weight: 500;
    }

    .modal-content input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
    }

    .modal-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    canvas {
      max-height: 220px !important;
    }

    .actions-inline {
      display: flex;
      justify-content: center;
      gap: 6px;
    }

    .actions-inline button {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
    }

    .actions-inline button.edit {
      color: #2563eb;
    }

    .actions-inline button.view {
      color: #16a34a;
    }

    .actions-inline button.delete {
      color: #dc2626;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="cube">‚ñ£</div>
      <div>
        <h1>Minimart</h1>
        <p>H·ªá th·ªëng qu·∫£n l√Ω</p>
      </div>
    </div>

    <nav class="menu" id="sidebarMenu"></nav>

    <div class="logout">
      <a class="item" href="FE_DangNhap.html">‚Ü™ ƒêƒÉng xu·∫•t</a>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Top bar -->
    <header class="topbar">
      <div class="search">
        <span>üîç</span>
        <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m, m√£ SKU..." />
      </div>

      <div class="top-actions">
        <button class="icon-btn" aria-label="Th√¥ng b√°o">üîî</button>
        <button class="icon-btn" aria-label="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
        <div class="user">
          <div class="avatar" id="userAvatar">A</div>
          <div class="meta">
            <div class="name" id="userName">Admin</div>
            <div class="role" id="userRole">Qu·∫£n l√Ω kho</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Title -->
    <section class="page-title">
      <h2>Qu·∫£n l√Ω kho h√†ng</h2>
      <p>Theo d√µi v√† qu·∫£n l√Ω t·ªìn kho hi·ªáu qu·∫£</p>
    </section>

    <!-- KPI cards -->
    <section class="kpis">
      <article class="kpi">
        <div class="kpi-head">
          <span class="kpi-title">T·ªïng s·ªë m·∫∑t h√†ng</span>
          <div class="kpi-ic">üß∞</div>
        </div>
        <div class="kpi-num">1,247</div>
        <div class="kpi-sub pos">+12% <span>so v·ªõi th√°ng tr∆∞·ªõc</span></div>
      </article>

      <article class="kpi">
        <div class="kpi-head">
          <span class="kpi-title">T·ªïng s·ªë l∆∞·ª£ng</span>
          <div class="kpi-ic">üìà</div>
        </div>
        <div class="kpi-num">8,965</div>
        <div class="kpi-sub pos">+8% <span>so v·ªõi th√°ng tr∆∞·ªõc</span></div>
      </article>

      <article class="kpi">
        <div class="kpi-head">
          <span class="kpi-title">Gi√° tr·ªã t·ªìn kho</span>
          <div class="kpi-ic">üí≤</div>
        </div>
        <div class="kpi-num">ƒë2.4M</div>
        <div class="kpi-sub pos">+15% <span>so v·ªõi th√°ng tr∆∞·ªõc</span></div>
      </article>

      <article class="kpi">
        <div class="kpi-head">
          <span class="kpi-title">S·∫Øp h·∫øt h·∫°n</span>
          <div class="kpi-ic">‚ö†Ô∏è</div>
        </div>
        <div class="kpi-num">23</div>
        <div class="kpi-sub neg">-5% <span>so v·ªõi th√°ng tr∆∞·ªõc</span></div>
      </article>
    </section>

    <!-- Charts -->
    <section class="chart-row">
      <article class="card">
        <div class="card-head">
          <h3>Bi·ªÉu ƒë·ªì nh·∫≠p/xu·∫•t</h3>
          <p>Theo d√µi s·ªë l∆∞·ª£ng s·∫£n ph·∫©m</p>
        </div>
        <canvas id="barChart"></canvas>
      </article>

      <article class="card">
        <div class="card-head">
          <h3>Ph√¢n b·ªë danh m·ª•c</h3>
          <p>T·ª∑ l·ªá % s·∫£n ph·∫©m trong kho</p>
        </div>
        <canvas id="donutChart"></canvas>
      </article>
    </section>

    <!-- Inventory table -->
    <section class="card">
      <div class="card-head between">
        <div>
          <h3>Danh s√°ch t·ªìn kho</h3>
          <p>Qu·∫£n l√Ω v√† theo d√µi t·∫•t c·∫£ s·∫£n ph·∫©m</p>
        </div>
        <div class="actions">
          <button class="btn primary">Ôºã Th√™m s·∫£n ph·∫©m</button>
          <button class="btn ghost" id="exportExcel">‚§ì Xu·∫•t Excel</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="search-sm">
          <span>üîé</span>
          <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." />
        </div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>M√£ SP</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Danh m·ª•c</th>
              <th class="num">S·ªë l∆∞·ª£ng</th>
              <th class="num">ƒê∆°n gi√°</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Nh√† cung c·∫•p</th>
              <th>H·∫°n s·ª≠ d·ª•ng</th>
              <th class="center">Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Th√™m / S·ª≠a -->
  <div id="productModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="modalTitle">Th√™m s·∫£n ph·∫©m</h3>
      <form id="productForm">
        <input type="hidden" id="productId" />

        <label>M√£ SP</label>
        <input type="text" id="maSP" required />

        <label>T√™n s·∫£n ph·∫©m</label>
        <input type="text" id="tenSP" required />

        <label>Danh m·ª•c</label>
        <input type="text" id="danhMuc" required />

        <label>S·ªë l∆∞·ª£ng</label>
        <input type="number" id="soLuong" required />

        <label>ƒê∆°n gi√° (vnƒë)</label>
        <input type="number" id="donGia" required />

        <label>Nh√† cung c·∫•p</label>
        <input type="text" id="nhaCungCap" />

        <label>H·∫°n s·ª≠ d·ª•ng</label>
        <input type="date" id="hanSD" />

        <div class="modal-actions">
          <button type="submit" class="btn primary">üíæ L∆∞u</button>
          <button type="button" class="btn ghost" onclick="closeModal()">‚ùå H·ªßy</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script>
    // === Sidebar + User ===
    const role = localStorage.getItem("role") || "guest";
    const loggedInUser = localStorage.getItem("loggedInUser") || "Kh√°ch";
    const sidebarMenu = document.getElementById("sidebarMenu");
    const userName = document.getElementById("userName");
    const userRole = document.getElementById("userRole");
    const userAvatar = document.getElementById("userAvatar");

    if (role === "admin") {
      sidebarMenu.innerHTML = `
        <a href="FE_TrangChu.html">üè† Trang ch·ªß</a>
        <a href="FE_QuanLySanPham.html">üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</a>
        <a class="active" href="FE_QuanLyKho.html">üè¨ Qu·∫£n l√Ω kho</a>
        <a href="FE_QuanLyTaiKhoan.html">üë• Qu·∫£n l√Ω t√†i kho·∫£n</a>
        <a href="FE_QuanLyNguoiDung.html">üßë‚Äçüíª Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        <a href="#">üßæ H√≥a ƒë∆°n</a>
        <a href="#">‚öôÔ∏è C√†i ƒë·∫∑t</a>
      `;
      userName.textContent = loggedInUser;
      userRole.textContent = "Qu·∫£n tr·ªã vi√™n";
    } else {
      sidebarMenu.innerHTML = `
        <a href="FE_TrangChu.html">üè† Trang ch·ªß</a>
        <a href="#">üõí S·∫£n ph·∫©m</a>
        <a href="#">üìû Th√¥ng tin li√™n h·ªá</a>
        <a href="#">üè¨ Danh s√°ch c·ª≠a h√†ng</a>
      `;
      userName.textContent = loggedInUser;
      userRole.textContent = "Ng∆∞·ªùi mua";
    }
    userAvatar.textContent = loggedInUser.charAt(0).toUpperCase();

    // === Chart.js ===
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'],
        datasets: [
          { label: 'Nh·∫≠p kho', data: [120, 150, 200, 180, 250, 300], backgroundColor: '#3b82f6' },
          { label: 'Xu·∫•t kho', data: [100, 130, 160, 170, 220, 260], backgroundColor: '#14b8a6' }
        ]
      },
      options: { plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
    });

    const ctxDonut = document.getElementById('donutChart').getContext('2d');
    new Chart(ctxDonut, {
      type: 'doughnut',
      data: {
        labels: ['Th·ª±c ph·∫©m', 'ƒê·ªì gia d·ª•ng', 'Y t·∫ø', 'Th·ªùi trang'],
        datasets: [{ data: [45, 25, 20, 10], backgroundColor: ['#3b82f6', '#14b8a6', '#f59e0b', '#ef4444'] }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });

    // === Inventory CRUD + LocalStorage ===
    const modal = document.getElementById("productModal");
    const modalTitle = document.getElementById("modalTitle");
    const productForm = document.getElementById("productForm");
    const btnAdd = document.querySelector(".btn.primary");
    const tableBody = document.querySelector(".table tbody");
    let editingRow = null;

    function loadProducts() {
      tableBody.innerHTML = "";
      let products = JSON.parse(localStorage.getItem("products"));
      if (!products) {
        products = [
          { maSP: "SP001", tenSP: "B√°nh m√¨ sandwich", danhMuc: "Th·ª±c ph·∫©m", soLuong: "45 c√°i", donGia: "25.000 ƒë", nhaCungCap: "C√¥ng ty ABC", hanSD: "2024-01-15" },
          { maSP: "SP002", tenSP: "N∆∞·ªõc u·ªëng Coca Cola", danhMuc: "ƒê·ªì u·ªëng", soLuong: "120 chai", donGia: "15.000 ƒë", nhaCungCap: "Coca Cola VN", hanSD: "2024-06-30" },
          { maSP: "SP003", tenSP: "B√†n ch·∫£i ƒë√°nh rƒÉng", danhMuc: "Y t·∫ø", soLuong: "8 c√°i", donGia: "35.000 ƒë", nhaCungCap: "P&G Vietnam", hanSD: "2025-12-31" }
        ];
        localStorage.setItem("products", JSON.stringify(products));
      }
      products.forEach(p => renderRow(p));
    }

    function saveProducts() {
      const rows = tableBody.querySelectorAll("tr");
      const products = [];
      rows.forEach(row => {
        products.push({
          maSP: row.cells[0].innerText,
          tenSP: row.cells[1].innerText,
          danhMuc: row.cells[2].innerText,
          soLuong: row.cells[3].innerText,
          donGia: row.cells[4].innerText,
          nhaCungCap: row.cells[6].innerText,
          hanSD: row.cells[7].innerText
        });
      });
      localStorage.setItem("products", JSON.stringify(products));
    }

    function renderRow(p) {
      let statusClass = "success", statusText = "C√≤n h√†ng";
      const soLuongNum = parseInt(p.soLuong);
      if (soLuongNum === 0) { statusClass = "error"; statusText = "H·∫øt h√†ng"; }
      else if (soLuongNum < 10) { statusClass = "warn"; statusText = "S·∫Øp h·∫øt"; }

      const newRow = tableBody.insertRow();
      newRow.innerHTML = `
        <td><a href="#" class="link">${p.maSP}</a></td>
        <td>${p.tenSP}</td>
        <td>${p.danhMuc}</td>
        <td class="num">${p.soLuong}</td>
        <td class="num">${p.donGia}</td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>${p.nhaCungCap}</td>
        <td class="exp">${p.hanSD}</td>
        <td>
          <div class="actions-inline">
            <button class="view">üëÅÔ∏è</button>
            <button class="edit">‚úèÔ∏è</button>
            <button class="delete">üóëÔ∏è</button>
          </div>
        </td>
      `;
    }

    function openModal(isEdit = false, row = null) {
      modal.style.display = "flex";
      if (isEdit && row) {
        modalTitle.textContent = "Ch·ªânh s·ª≠a s·∫£n ph·∫©m";
        editingRow = row;
        document.getElementById("maSP").value = row.cells[0].innerText;
        document.getElementById("tenSP").value = row.cells[1].innerText;
        document.getElementById("danhMuc").value = row.cells[2].innerText;
        document.getElementById("soLuong").value = parseInt(row.cells[3].innerText);
        document.getElementById("donGia").value = parseInt(row.cells[4].innerText.replace(/\D/g, ""));
        document.getElementById("nhaCungCap").value = row.cells[6].innerText;
        document.getElementById("hanSD").value = row.cells[7].innerText;
      } else {
        modalTitle.textContent = "Th√™m s·∫£n ph·∫©m";
        editingRow = null;
        productForm.reset();
      }
    }

    function closeModal() {
      modal.style.display = "none";
    }

    btnAdd.addEventListener("click", () => openModal(false));

    productForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const product = {
        maSP: document.getElementById("maSP").value,
        tenSP: document.getElementById("tenSP").value,
        danhMuc: document.getElementById("danhMuc").value,
        soLuong: document.getElementById("soLuong").value + " c√°i",
        donGia: new Intl.NumberFormat("vi-VN").format(document.getElementById("donGia").value) + " ƒë",
        nhaCungCap: document.getElementById("nhaCungCap").value,
        hanSD: document.getElementById("hanSD").value
      };

      if (editingRow) {
        editingRow.cells[0].innerText = product.maSP;
        editingRow.cells[1].innerText = product.tenSP;
        editingRow.cells[2].innerText = product.danhMuc;
        editingRow.cells[3].innerText = product.soLuong;
        editingRow.cells[4].innerText = product.donGia;
        editingRow.cells[6].innerText = product.nhaCungCap;
        editingRow.cells[7].innerText = product.hanSD;
      } else {
        renderRow(product);
      }

      saveProducts();
      closeModal();
    });

    tableBody.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const row = btn.closest("tr");

      if (btn.classList.contains("edit")) {
        openModal(true, row);
      } else if (btn.classList.contains("delete")) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) {
          row.remove();
          saveProducts();
        }
      } else if (btn.classList.contains("view")) {
        alert(`Chi ti·∫øt s·∫£n ph·∫©m: ${row.cells[1].innerText}`);
      }
    });

    // === Search realtime ===
    document.getElementById("searchInput").addEventListener("input", (e) => {
      const keyword = e.target.value.toLowerCase();
      const rows = tableBody.querySelectorAll("tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(keyword) ? "" : "none";
      });
    });

    // === Xu·∫•t Excel ===
    document.getElementById("exportExcel").addEventListener("click", () => {
      let wb = XLSX.utils.book_new();
      let ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
      XLSX.utils.book_append_sheet(wb, ws, "Danh s√°ch kho");
      XLSX.writeFile(wb, "DanhSachKho.xlsx");
    });

    loadProducts();
  </script>
</body>

</html>
